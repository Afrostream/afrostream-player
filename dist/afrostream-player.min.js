/*! afrostream-player - v0.2.0 - 2015-10-23
* Copyright (c) 2015 benjipott; Licensed Apache-2.0 */
!function(a,b){"use strict";b.Afrostream=b.Component.extend({init:function(a,c){b.Component.call(this,a,c),a.on("loadstart",b.bind(this,this.onLoadStart)),this.mediaPlayer_=a.mediaPlayer,this.tech_=a.tech}}),b.Afrostream.prototype.streamInfo=null,b.Afrostream.prototype.tech_=null,b.Afrostream.prototype.mediaPlayer_=null,b.Afrostream.prototype.onLoadStart=function(){this.addMediaPlayerHandlers()},b.Afrostream.prototype.addMediaPlayerHandlers=function(){b.on(this.mediaPlayer_,MediaPlayer.events.STREAM_INITIALIZED,b.bind(this,this.onInitialized)),b.on(this.mediaPlayer_,MediaPlayer.events.STREAM_SWITCH_STARTED,b.bind(this,this.onStreamSwitchComplete)),b.on(this.mediaPlayer_,MediaPlayer.events.STREAM_SWITCH_COMPLETED,b.bind(this,this.onStreamSwitchComplete)),b.on(this.mediaPlayer_,MediaPlayer.events.METRIC_CHANGED,b.bind(this,this.onMetricChanged))},b.Afrostream.prototype.setQuality=function(a){var b=this.mediaPlayer_.getBitrateInfoListFor("video");this.mediaPlayer_.setAutoSwitchQuality(a>=b.length),this.mediaPlayer_.setQualityFor("video",a),this.tech_.featuresBitrateIndex=a,this.tech_.trigger("bitratechange")},b.Afrostream.prototype.onStreamSwitchComplete=function(a){this.tech_.featuresBitrateIndex=a.data.toStreamInfo.index,this.streamInfo=a.data.toStreamInfo;var c=b.fixEvent({type:"bitratechange",data:a.data});this.tech_.trigger(c)},b.Afrostream.prototype.onMetricChanged=function(a){if("video"===a.data.stream||"audio"===a.data.stream){var c=this.getCribbedMetricsFor(a.data.stream);if(c&&(this.metrics_[a.data.stream]=b.util.mergeOptions(this.metrics_[a.data.stream],c),"video"===a.data.stream&&c.bitrateIndex!==this.tech_.featuresBitrateIndex)){var d=this.tech_.featuresBitrateIndex;this.tech_.featuresBitrateIndex=c.bitrateIndex,this.tech_.featuresBitrate=c,this.tech_.trigger(c.bitrateIndex>d?"bandwidthIncrease":"bandwidthDecrease")}}},b.Afrostream.prototype.onInitialized=function(a,c){c&&this.player().error(c);var d=this.mediaPlayer_.getBitrateInfoListFor("video");this.tech_.featuresBitrates=d,this.tech_.featuresBitrateIndex=d.length,b.log("Bitrates available:"+d.length),this.tech_.setQuality=b.bind(this,this.setQuality),this.tech_.trigger("initialized"),this.tech_.trigger("bitratechange")},b.Afrostream.METRICS_DATA={bandwidth:-1,bitrateIndex:0,pendingIndex:"",numBitrates:0,bufferLength:0,droppedFrames:0,movingLatency:0,movingDownload:0,movingRatio:0,requestsQueue:0},b.Afrostream.prototype.metrics_={video:b.util.mergeOptions({},b.Afrostream.METRICS_DATA),audio:b.util.mergeOptions({},b.Afrostream.METRICS_DATA)},b.Afrostream.prototype.getPlaybackStatistics=function(){return this.metrics_},b.Afrostream.prototype.getCribbedMetricsFor=function(a){var b,c,d,e,f,g,h,i,j,k=this.mediaPlayer_.getMetricsFor(a),l=this.mediaPlayer_.getMetricsExt(),m=0,n={},o={},p={},q=0,r=function(a,b){var c,d,e,f;c=b.slice(-20).filter(function(b){return b.responsecode>=200&&b.responsecode<300&&!!b.mediaduration&&"Media Segment"===b.type&&b.stream===a}).slice(-4),c.length>0&&(e=c.map(function(a){return Math.abs(a.tresponse.getTime()-a.trequest.getTime())/1e3}),n[a]={average:e.reduce(function(a,b){return a+b})/e.length,high:e.reduce(function(a,b){return b>a?b:a}),low:e.reduce(function(a,b){return b>a?a:b}),count:e.length},d=c.map(function(a){return Math.abs(a.tfinish.getTime()-a.tresponse.getTime())/1e3}),o[a]={average:d.reduce(function(a,b){return a+b})/d.length,high:d.reduce(function(a,b){return b>a?b:a}),low:d.reduce(function(a,b){return b>a?a:b}),count:d.length},f=c.map(function(a){return a.mediaduration}),p[a]={average:f.reduce(function(a,b){return a+b})/d.length/o[a].average,high:f.reduce(function(a,b){return b>a?b:a})/o[a].low,low:f.reduce(function(a,b){return b>a?a:b})/o[a].high,count:f.length})};if(k&&l){b=l.getCurrentRepresentationSwitch(k),c=l.getCurrentBufferLevel(k),d=l.getHttpRequests(k),e=l.getCurrentDroppedFrames(k),j=l.getRequestsQueue?l.getRequestsQueue(k):{},r("video",d),r("audio",d);var s=this.streamInfo?this.streamInfo.index:0;return null!==b&&(f=l.getIndexForRepresentation(b.to,s),g=l.getBandwidthForRepresentation(b.to,s),g/=1e3,g=Math.round(g)),i=l.getMaxIndexForBufferType(a,s),null!==c&&(m=c.level.toPrecision(5)),null!==e&&(q=e.droppedFrames),(isNaN(g)||void 0===g)&&(g=0),(isNaN(f)||void 0===f)&&(f=0),(isNaN(i)||void 0===i)&&(i=0),(isNaN(m)||void 0===m)&&(m=0),h=this.mediaPlayer_.getQualityFor(a),{bandwidth:g,bitrateIndex:f,pendingIndex:h!==f?"(-> "+h+")":"",numBitrates:i,bufferLength:m,droppedFrames:q,movingLatency:n,movingDownload:o,movingRatio:p,requestsQueue:j}}return null},b.options.children.afrostream={},b.MediaTechController.prototype.getPlaybackStatistics=function(){return{video:{bandwidth:-1},audio:{bandwidth:-1}}}}(window,window.videojs),function(a,b){"object"==typeof module&&"object"==typeof module.exports?module.exports=a.document?b(a,!0):function(a){if(!a.document)throw new Error("vjs requires a window with a document");return b(a)}:b(a)}("undefined"!=typeof window?window:this,function(a,b){return videojs}),function(a,b){"use strict";b.BitrateMenuButton=b.MenuButton.extend({init:function(a,c){b.MenuButton.call(this,a,c),this.updateVisibility(),this.updateLabel(),this.on(a,"loadstart",this.updateVisibility),this.on(a,"initialized",this.update),this.on(a,"bitratechange",this.updateVisibility),this.on(a,"bitratechange",this.updateLabel)}}),b.ControlBar.prototype.options_.children.bitrateMenuButton={},b.BitrateMenuButton.Labels=["bas","moyen","normal","HD","auto"],b.BitrateMenuButton.prototype.buttonText="Quality Selection",b.BitrateMenuButton.prototype.className="vjs-bitrate",b.BitrateMenuButton.prototype.createEl=function(){var a=b.MenuButton.prototype.createEl.call(this);return this.labelEl_=b.createEl("div",{className:"vjs-bitrate-value",innerHTML:1}),a.appendChild(this.labelEl_),a},b.BitrateMenuButton.prototype.createMenu=function(){if(this.player().tech){var a=new b.Menu(this.player()),c=this.player().tech.featuresBitrates;if(c){a.addChild(new b.BitrateMenuItem(this.player(),{qualityIndex:c.length,bitrate:"Auto"}));for(var d=c.length-1;d>=0;d--){var e=c[d];a.addChild(new b.BitrateMenuItem(this.player(),e))}}return a}},b.BitrateMenuButton.prototype.updateARIAAttributes=function(){this.el().setAttribute("aria-valuenow",this.player().tech.getBitrate())},b.BitrateMenuButton.prototype.onClick=function(){for(var a=this.player().playbackRate(),b=this.player().tech.featuresBitrateIndex,c=b[0],d=0;d<b.length;d++)if(b[d]>a){c=b[d];break}this.player().playbackRate(c)},b.BitrateMenuButton.prototype.bitratesSupported=function(){return this.player().tech&&this.player().tech.featuresBitrates&&this.player().tech.featuresBitrates.length>0},b.BitrateMenuButton.prototype.updateVisibility=function(){this.bitratesSupported()?this.removeClass("vjs-hidden"):this.addClass("vjs-hidden")},b.BitrateMenuButton.prototype.updateLabel=function(){if(this.bitratesSupported()){var a=this.player().tech.featuresBitrateIndex;this.labelEl_.innerHTML=b.BitrateMenuButton.Labels[a]}},b.BitrateMenuItem=b.MenuItem.extend({contentElType:"button",init:function(a,c){var d=this.label=parseInt(c.bitrate,10)?c.bitrate/1e3:c.bitrate,e=this.qualityIndex=c.qualityIndex;c.label=b.BitrateMenuButton.Labels[e]||d,c.selected=e===a.tech.featuresBitrates.length||1,b.MenuItem.call(this,a,c),this.on(a,"bitratechange",this.update)}}),b.BitrateMenuItem.prototype.onClick=function(){b.MenuItem.prototype.onClick.call(this),this.player().tech.setQuality(this.qualityIndex)},b.BitrateMenuItem.prototype.update=function(){this.selected(this.player().tech.featuresBitrateIndex===this.bitrateIndex)}}(window,window.videojs),function(){var a=function(a,c){function d(){this.constructor=a}for(var e in c)b.call(c,e)&&(a[e]=c[e]);return d.prototype=c.prototype,a.prototype=new d,a.__super__=c.prototype,a},b={}.hasOwnProperty;vjs.addLanguage("de",{"CASTING TO":"WIEDERGABE AUF"}),vjs.addLanguage("it",{"CASTING TO":"PLAYBACK SU"}),vjs.plugin("chromecast",function(a){return this.chromecastComponent=new vjs.ChromecastComponent(this,a),this.controlBar.addChild(this.chromecastComponent)}),vjs.ChromecastComponent=function(b){function c(a,b){this.settings=b,c.__super__.constructor.call(this,a,this.settings),a.controls()||this.disable(),this.hide(),this.initializeApi()}return a(c,b),c.prototype.buttonText="Chromecast",c.prototype.inactivityTimeout=2e3,c.prototype.apiInitialized=!1,c.prototype.apiSession=null,c.prototype.apiMedia=null,c.prototype.casting=!1,c.prototype.paused=!0,c.prototype.muted=!1,c.prototype.currentVolume=1,c.prototype.currentMediaTime=0,c.prototype.timer=null,c.prototype.timerStep=1e3,c.prototype.tryingReconnect=0,c.prototype.initializeApi=function(){var a,b,c;if(vjs.IS_CHROME)return chrome.cast&&chrome.cast.isAvailable?(vjs.log("Cast APIs are available"),b=this.settings.appId||chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,c=new chrome.cast.SessionRequest(b),a=new chrome.cast.ApiConfig(c,this.sessionJoinedListener,this.receiverListener.bind(this)),chrome.cast.initialize(a,this.onInitSuccess.bind(this),this.castError)):void vjs.log("Cast APIs not available")},c.prototype.sessionJoinedListener=function(a){return console.log("Session joined")},c.prototype.receiverListener=function(a){return"available"===a?this.show():void 0},c.prototype.onInitSuccess=function(){return this.apiInitialized=!0},c.prototype.castError=function(a){return vjs.log("Cast Error: "+JSON.stringify(a))},c.prototype.doLaunch=function(){return vjs.log("Cast video: "+this.player_.currentSrc()),this.apiInitialized?chrome.cast.requestSession(this.onSessionSuccess.bind(this),this.castError):vjs.log("Session not initialized")},c.prototype.onSessionSuccess=function(a){var b,c,d,e,f,g,h;if(vjs.log("Session initialized: "+a.sessionId),this.selectedTrack=null,this.apiSession=a,this.addClass("connected"),e=new chrome.cast.media.MediaInfo(this.player_.currentSrc(),this.player_.currentType()),this.settings.metadata){e.metadata=new chrome.cast.media.GenericMediaMetadata,f=this.settings.metadata;for(c in f)h=f[c],e.metadata[c]=h;this.player_.options_.poster&&(b=new chrome.cast.Image(this.player_.options_.poster),e.metadata.images=[b])}if(this.plTracks=this.settings.tracks,this.plTracks){this.nbTrack=1,this.tracks=[],g=this.plTracks;for(c in g)h=g[c],this.track=new chrome.cast.media.Track(this.nbTrack,chrome.cast.media.TrackType.TEXT),this.track.trackContentId=h.src,this.track.trackContentType=h.type,this.track.subtype=chrome.cast.media.TextTrackType.CAPTIONS,this.track.name=h.label,this.track.language=h.language,"showing"===h.mode&&(this.selectedTrack=this.track),this.track.customData=null,this.tracks.push(this.track),++this.nbTrack;e.textTrackStyle=new chrome.cast.media.TextTrackStyle,e.tracks=this.tracks}return d=new chrome.cast.media.LoadRequest(e),d.autoplay=!0,d.currentTime=this.player_.currentTime(),this.apiSession.loadMedia(d,this.onMediaDiscovered.bind(this),this.castError),this.apiSession.addUpdateListener(this.onSessionUpdate.bind(this))},c.prototype.onTrackChangeHandler=function(){var a,b,c,d;for(this.activeTrackIds=[],c=this.player_.textTracks(),a=0,b=c.length;b>a;a++)d=c[a],"showing"===d.mode&&this.activeTrackIds.push(d.id);return this.tracksInfoRequest=new chrome.cast.media.EditTracksInfoRequest(this.activeTrackIds),this.apiMedia?this.apiMedia.editTracksInfo(this.tracksInfoRequest,this.onTrackSuccess.bind(this),this.onTrackError.bind(this)):void 0},c.prototype.onTrackSuccess=function(){return vjs.log("track added")},c.prototype.onTrackError=function(){return vjs.log("track error")},c.prototype.onMediaDiscovered=function(a){return this.apiMedia=a,this.apiMedia.addUpdateListener(this.onMediaStatusUpdate.bind(this)),this.selectedTrack&&(this.activeTrackIds=[this.selectedTrack.trackId],this.tracksInfoRequest=new chrome.cast.media.EditTracksInfoRequest(this.activeTrackIds),this.apiMedia.editTracksInfo(this.tracksInfoRequest,this.onTrackSuccess.bind(this),this.onTrackError.bind(this))),this.startProgressTimer(this.incrementMediaTime.bind(this)),this.player_.loadTech("ChromecastTech",{receiver:this.apiSession.receiver.friendlyName}),this.casting=!0,this.paused=this.player_.paused(),this.inactivityTimeout=this.player_.options_.inactivityTimeout,this.player_.options_.inactivityTimeout=0,this.player_.userActive(!0)},c.prototype.onSessionUpdate=function(a){return this.apiMedia?a?void 0:this.onStopAppSuccess():void 0},c.prototype.onMediaStatusUpdate=function(a){if(this.apiMedia)switch(this.currentMediaTime=this.apiMedia.currentTime,this.apiMedia.playerState){case chrome.cast.media.PlayerState.IDLE:return this.currentMediaTime=0,this.trigger("timeupdate"),this.onStopAppSuccess();case chrome.cast.media.PlayerState.PAUSED:if(this.paused)return;return this.player_.pause(),this.paused=!0;case chrome.cast.media.PlayerState.PLAYING:if(!this.paused)return;return this.player_.play(),this.paused=!1}},c.prototype.startProgressTimer=function(a){return this.timer&&(clearInterval(this.timer),this.timer=null),this.timer=setInterval(a.bind(this),this.timerStep)},c.prototype.play=function(){return this.apiMedia&&this.paused?(this.apiMedia.play(null,this.mediaCommandSuccessCallback.bind(this,"Playing: "+this.apiMedia.sessionId),this.onError),this.paused=!1):void 0},c.prototype.pause=function(){return this.apiMedia?this.paused?void 0:(this.apiMedia.pause(null,this.mediaCommandSuccessCallback.bind(this,"Paused: "+this.apiMedia.sessionId),this.onError),this.paused=!0):void 0},c.prototype.seekMedia=function(a){var b;return b=new chrome.cast.media.SeekRequest,b.currentTime=a,this.player_.controlBar.progressControl.seekBar.videoWasPlaying&&(b.resumeState=chrome.cast.media.ResumeState.PLAYBACK_START),this.apiMedia.seek(b,this.onSeekSuccess.bind(this,a),this.onError)},c.prototype.onSeekSuccess=function(a){return this.currentMediaTime=a},c.prototype.setMediaVolume=function(a,b){var c,d;if(this.apiMedia)return d=new chrome.cast.Volume,d.level=a,d.muted=b,this.currentVolume=d.level,this.muted=b,c=new chrome.cast.media.VolumeRequest,c.volume=d,this.apiMedia.setVolume(c,this.mediaCommandSuccessCallback.bind(this,"Volume changed"),this.onError),this.player_.trigger("volumechange")},c.prototype.incrementMediaTime=function(){return this.apiMedia.playerState===chrome.cast.media.PlayerState.PLAYING?this.currentMediaTime<this.apiMedia.media.duration?(this.currentMediaTime+=1,this.trigger("timeupdate")):(this.currentMediaTime=0,clearInterval(this.timer)):void 0},c.prototype.mediaCommandSuccessCallback=function(a,b){return vjs.log(a)},c.prototype.onError=function(){return vjs.log("error")},c.prototype.stopCasting=function(){return this.apiSession.stop(this.onStopAppSuccess.bind(this),this.onError)},c.prototype.onStopAppSuccess=function(){return clearInterval(this.timer),this.casting=!1,this.removeClass("connected"),this.player_.src(this.player_.options_.sources),this.paused||this.player_.one("seeked",function(){return this.player_.play()}),this.player_.currentTime(this.currentMediaTime),this.player_.tech.setControls(!1),this.player_.options_.inactivityTimeout=this.inactivityTimeout,this.apiMedia=null,this.apiSession=null},c.prototype.buildCSSClass=function(){return c.__super__.buildCSSClass.apply(this,arguments)+"vjs-chromecast-button"},c.prototype.onClick=function(){return c.__super__.onClick.apply(this,arguments),this.casting?this.stopCasting():this.doLaunch()},c}(vjs.Button),vjs.ChromecastTech=function(b){function c(a,b,d){this.featuresVolumeControl=!0,this.movingMediaElementInDOM=!1,this.featuresFullscreenResize=!1,this.featuresProgressEvents=!0,this.receiver=b.source.receiver,c.__super__.constructor.call(this,a,b,d),this.triggerReady()}return a(c,b),c.isSupported=function(){return this.player_.chromecastComponent.apiInitialized},c.canPlaySource=function(a){return"video/mp4"===a.type||"video/webm"===a.type||"application/x-mpegURL"===a.type||"application/vnd.apple.mpegURL"===a.type},c.prototype.createEl=function(){var a;return a=document.createElement("div"),a.id=this.player_.id_+"_chromecast_api",a.className="vjs-tech vjs-tech-chromecast",a.innerHTML='<div class="casting-image" style="background-image: url(\''+this.player_.options_.poster+'\')"></div>\n<div class="casting-overlay">\n  <div class="casting-information">\n    <div class="casting-icon">&#58880</div>\n    <div class="casting-description"><small>'+this.localize("CASTING TO")+"</small><br>"+this.receiver+"</div>\n  </div>\n</div>",a.player=this.player_,vjs.insertFirst(a,this.player_.el()),a},c.prototype.play=function(){return this.player_.chromecastComponent.play(),this.player_.onPlay()},c.prototype.pause=function(){return this.player_.chromecastComponent.pause(),this.player_.onPause()},c.prototype.paused=function(){return this.player_.chromecastComponent.paused},c.prototype.currentTime=function(){return this.player_.chromecastComponent.currentMediaTime},c.prototype.setCurrentTime=function(a){return this.player_.chromecastComponent.seekMedia(a)},c.prototype.volume=function(){return this.player_.chromecastComponent.currentVolume},c.prototype.setVolume=function(a){return this.player_.chromecastComponent.setMediaVolume(a,!1)},c.prototype.muted=function(){return this.player_.chromecastComponent.muted},c.prototype.setMuted=function(a){return this.player_.chromecastComponent.setMediaVolume(this.player_.chromecastComponent.currentVolume,a)},c.prototype.supportsFullScreen=function(){return!1},c}(vjs.MediaTechController)}.call(this),function(){var a=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};videojs.plugin("ga",function(b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w;return null==b&&(b={}),c={},this.options()["data-setup"]&&(l=JSON.parse(this.options()["data-setup"]),l.ga&&(c=l.ga)),d=["loaded","percentsPlayed","start","end","seek","play","pause","resize","volumeChange","error","fullscreen"],i=b.eventsToTrack||c.eventsToTrack||d,o=b.percentsPlayedInterval||c.percentsPlayedInterval||10,g=b.eventCategory||c.eventCategory||"Video",h=b.eventLabel||c.eventLabel,b.debug=b.debug||!1,n=[],s=r=0,t=!1,k=function(){h||(h=this.currentSrc().split("/").slice(-1)[0].replace(/\.(\w{3,4})(\?.*)?$/i,"")),a.call(i,"loadedmetadata")>=0&&u("loadedmetadata",!0)},v=function(){var b,c,d,e,f;for(b=Math.round(this.currentTime()),c=Math.round(this.duration()),e=Math.round(b/c*100),d=f=0;99>=f;d=f+=o)e>=d&&a.call(n,d)<0&&(a.call(i,"start")>=0&&0===d&&e>0?u("start",!0):a.call(i,"percentsPlayed")>=0&&0!==e&&u("percent played",!0,d),e>0&&n.push(d));a.call(i,"seek")>=0&&(s=r,r=b,Math.abs(s-r)>1&&(t=!0,u("seek start",!1,s),u("seek end",!1,r)))},e=function(){u("end",!0)},p=function(){var a;a=Math.round(this.currentTime()),u("play",!0,a),t=!1},m=function(){var a,b;a=Math.round(this.currentTime()),b=Math.round(this.duration()),a===b||t||u("pause",!1,a)},w=function(){var a;a=this.muted()===!0?0:this.volume(),u("volume change",!1,a)},q=function(){u("resize - "+this.width()+"*"+this.height(),!0)},f=function(){var a;a=Math.round(this.currentTime()),u("error",!0,a)},j=function(){var a;a=Math.round(this.currentTime()),("function"==typeof this.isFullscreen?this.isFullscreen():void 0)||("function"==typeof this.isFullScreen?this.isFullScreen():void 0)?u("enter fullscreen",!1,a):u("exit fullscreen",!1,a)},u=function(a,c,d){window.ga?ga("send","event",{eventCategory:g,eventAction:a,eventLabel:h,eventValue:d,nonInteraction:c}):window._gaq?_gaq.push(["_trackEvent",g,a,h,d,c]):b.debug&&console.log("Google Analytics not detected")},this.ready(function(){return this.on("loadedmetadata",k),this.on("timeupdate",v),a.call(i,"end")>=0&&this.on("ended",e),a.call(i,"play")>=0&&this.on("play",p),a.call(i,"pause")>=0&&this.on("pause",m),a.call(i,"volumeChange")>=0&&this.on("volumechange",w),a.call(i,"resize")>=0&&this.on("resize",q),a.call(i,"error")>=0&&this.on("error",f),a.call(i,"fullscreen")>=0?this.on("fullscreenchange",j):void 0}),{sendbeacon:u}})}.call(this),function(a,b){"use strict";b.Metrics=b.Component.extend({init:function(a,c){b.Component.call(this,a,c),this.setupTriggers(),this.browserInfo=b.Metrics.getBrowser()}}),b.Metrics.prototype.options_={option:!0,user_id:666,method:"POST",responseType:"json",timeout:1e3,url:"//stats.afrostream.tv/api/v1/events",trackEvents:["loadstart","ping","firstplay","ended","dispose","waiting","error","bandwidthIncrease","bandwidthDecrease","dispose"]},b.Metrics.getBrowser=function(){var a,b,c,d,e={},f=null,g=null,h=null,i=null;return a=function(){var a=navigator.userAgent.toLowerCase(),b=/(ie|firefox|chrome|safari|opera)(?:.*version)?(?:[ \/])?([\w.]+)/.exec(a),c=/(mac|win|linux|freebsd|mobile|iphone|ipod|ipad|android|blackberry|j2me|webtv)/.exec(a);a.match(/trident\/7\./)?(f="ie",g=11):b&&b.length>2&&(f=b[1],g=b[2]),c&&c.length>1&&(h=c[1]),i=navigator.oscpu||navigator.appName},b=function(){e.browser=f,e.version=parseInt(g,10)||null,e.os=h,e.osVersion=i},c=function(){"mac"===h&&(h="osx")},d=function(){"safari"===h&&(g=g.substring(0,1))},a(),c(),d(),b(),e},b.Metrics.INTERVAL_PING=6e4,b.Metrics.BASE_KEYS=["user_id","type","fqdn"],b.Metrics.METRICS_DATA={bandwidth:-1,bitrateIndex:0,pendingIndex:"",numBitrates:0,bufferLength:0,droppedFrames:0,movingLatency:0,movingDownload:0,movingRatio:0,requestsQueue:0},b.Metrics.prototype.metrics_={video:b.util.mergeOptions({},b.Metrics.METRICS_DATA),audio:b.util.mergeOptions({},b.Metrics.METRICS_DATA)},b.Metrics.REQUIRED_KEY={bandwidthIncrease:["video_bitrate","audio_bitrate"],bandwidthDecrease:["video_bitrate","audio_bitrate"],ping:[],buffering:[],error:["number","message"],start:["video_bitrate","audio_bitrate","os","os_version","web_browser","web_browser_version","resolution_size","flash_version","html5_video","relative_url"],stop:["timeout","frames_dropped"]},b.Metrics.URL_MATCH=/https?:\/\/(?:www\.)?([-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b)*(\/[\/\d\w\.-]*)*(?:[\?])*(.+)*/gi,b.Metrics.prototype.pathUrl="",b.Metrics.prototype.oldType=null,b.Metrics.prototype.intervalPing=0,b.Metrics.prototype.browserInfo={},b.Metrics.prototype.eventHandler=function(a){var c={type:a.type},d=!1;switch(c.type){case"error":break;case"dispose":case"ended":c.type===this.oldType&&(d=!0),c.type="stop";break;case"loadstart":var e=this.player().manifestUrl||this.player().currentSrc();this.pathUrl=b.Metrics.URL_MATCH.exec(e),d=!0;break;case"firstplay":c.type="start",this.intervalPing=this.setInterval(this.onPing,b.Metrics.INTERVAL_PING);break;case"waiting":c.type="buffering";break;case"bandwidthIncrease":case"bandwidthDecrease":}this.oldType=c.type,d||this.notify(c)},b.Metrics.prototype.onPing=function(){this.player().trigger("ping")},b.Metrics.prototype.setupTriggers=function(){for(var a=this.options_.trackEvents,c=a.length-1;c>=0;c--)this.player().on(a[c],b.bind(this,this.eventHandler))},b.Metrics.pick=function(a,b,c){var d={};return"string"==typeof b&&(b=[b]),Object.keys(a).forEach(function(c){b.indexOf(c)>-1&&(d[c]=a[c])},c),d},b.Metrics.prototype.getRequiredKeys=function(a){return b.Metrics.BASE_KEYS.concat(b.Metrics.REQUIRED_KEY[a]||[])},b.Metrics.prototype.notify=function(a){var c=this.player();a.user_id=this.options().user_id,a.fqdn=this.pathUrl[1],a.os=this.browserInfo.os,a.os_version=this.browserInfo.osVersion.toString(),a.web_browser=this.browserInfo.browser,a.web_browser_version=this.browserInfo.version.toString(),a.resolution_size=screen.width+"x"+screen.height,a.flash_version=b.Flash.version().join(","),a.html5_video="Html5"===c.techName,a.relative_url=this.pathUrl[2],a.timeout=!1,a.frames_dropped=0;try{var d=c.techGet("getPlaybackStatistics");this.metrics_=b.util.mergeOptions(this.metrics_,d),a.video_bitrate=this.metrics_.video.bandwidth||0,a.audio_bitrate=this.metrics_.audio.bandwidth||0;var e=b.Metrics.pick(a,this.getRequiredKeys(a.type));this.xhr(this.options(),e)}catch(f){b.log(f)}},b.Metrics.prototype.xhr=function(c,d,e){var f,g,h={method:"GET",timeout:45e3};"function"!=typeof e&&(e=function(){}),"object"==typeof c&&(h=b.util.mergeOptions(h,c),c=h.url);var i=a.XMLHttpRequest;"undefined"==typeof i&&(i=function(){try{return new a.ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(b){}try{return new a.ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(c){}try{return new a.ActiveXObject("Msxml2.XMLHTTP")}catch(d){}throw new Error("This browser does not support XMLHttpRequest.")}),f=new i,f.open(h.method,c),f.url=c,f.requestTime=(new Date).getTime(),f.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),h.responseType&&(f.responseType=h.responseType),h.withCredentials&&(f.withCredentials=!0),h.timeout&&(g=a.setTimeout(function(){4!==f.readyState&&(f.timedout=!0,f.abort())},h.timeout)),f.onreadystatechange=function(){return 4===this.readyState?(a.clearTimeout(g),f.timedout?e.call(this,"timeout",c):this.status>=400||0===this.status?e.call(this,!0,c):(this.response&&(this.responseTime=(new Date).getTime(),this.roundTripTime=this.responseTime-this.requestTime,this.bytesReceived=this.response.byteLength||this.response.length,this.bandwidth=Math.floor(this.bytesReceived/this.roundTripTime*8*1e3)),e.call(this,!1,c))):void 0};var j="";if("object"==typeof d)for(var k in d)j+=(0===j.length?"":"&")+k+"="+encodeURIComponent(d[k]);return f.send(j),f},b.options.children.metrics={}}(window,window.videojs);